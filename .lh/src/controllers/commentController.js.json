{
    "sourceFile": "src/controllers/commentController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1762458437728,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762845310433,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,6 @@\n // blog-backend/src/controllers/commentController.js\n+const mongoose = require(\"mongoose\");\n const Comment = require(\"../models/Comment\");\n const Blog = require(\"../models/Blog\");\n \n // -------- PUBLIC --------\n"
                },
                {
                    "date": 1762845324537,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,10 @@\n const Blog = require(\"../models/Blog\");\n \n // -------- PUBLIC --------\n \n+const isNonEmpty = (v) => typeof v === \"string\" && v.trim().length > 0;\n+\n // POST /api/comments\n // body: { postId, name, email, message }\n exports.createPublic = async (req, res) => {\n   try {\n"
                },
                {
                    "date": 1762845341733,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,26 +8,26 @@\n const isNonEmpty = (v) => typeof v === \"string\" && v.trim().length > 0;\n \n // POST /api/comments\n // body: { postId, name, email, message }\n-exports.createPublic = async (req, res) => {\n-  try {\n-    const { postId, name, email, message } = req.body || {};\n-    if (!postId || !name || !email || !message) {\n-      return res.status(400).json({ error: \"Missing required fields\" });\n-    }\n+// exports.createPublic = async (req, res) => {\n+//   try {\n+//     const { postId, name, email, message } = req.body || {};\n+//     if (!postId || !name || !email || !message) {\n+//       return res.status(400).json({ error: \"Missing required fields\" });\n+//     }\n \n-    // sanity: make sure blog exists\n-    const exists = await Blog.findById(postId).lean();\n-    if (!exists) return res.status(404).json({ error: \"Post not found\" });\n+//     // sanity: make sure blog exists\n+//     const exists = await Blog.findById(postId).lean();\n+//     if (!exists) return res.status(404).json({ error: \"Post not found\" });\n \n-    const comment = await Comment.create({ post: postId, name, email, message });\n-    res.status(201).json({ ok: true, id: comment._id });\n-  } catch (err) {\n-    console.error(\"createPublic comment error\", err);\n-    res.status(500).json({ error: \"Server error\" });\n-  }\n-};\n+//     const comment = await Comment.create({ post: postId, name, email, message });\n+//     res.status(201).json({ ok: true, id: comment._id });\n+//   } catch (err) {\n+//     console.error(\"createPublic comment error\", err);\n+//     res.status(500).json({ error: \"Server error\" });\n+//   }\n+// };\n \n // GET /api/comments?postId=...  (approved only)\n exports.listPublic = async (req, res) => {\n   try {\n"
                },
                {
                    "date": 1762845362072,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,8 +27,54 @@\n //     res.status(500).json({ error: \"Server error\" });\n //   }\n // };\n \n+\n+exports.createPublic = async (req, res) => {\n+  try {\n+    // Log once to see what actually arrives\n+    console.log(\"POST /api/comments body:\", req.body);\n+\n+    // Accept either postId or post (client/older code compatibility)\n+    const rawPostId = req.body?.postId ?? req.body?.post;\n+    const name = (req.body?.name || \"\").trim();\n+    const email = (req.body?.email || \"\").trim();\n+    const message = (req.body?.message || \"\").trim();\n+\n+    if (!rawPostId || !isNonEmpty(name) || !isNonEmpty(email) || !isNonEmpty(message)) {\n+      return res.status(400).json({\n+        error: \"Missing required fields\",\n+        details: {\n+          postId: Boolean(rawPostId),\n+          name: isNonEmpty(name),\n+          email: isNonEmpty(email),\n+          message: isNonEmpty(message),\n+        },\n+      });\n+    }\n+\n+    if (!mongoose.isValidObjectId(rawPostId)) {\n+      return res.status(400).json({ error: \"Invalid postId\" });\n+    }\n+\n+    // sanity: post must exist\n+    const post = await Blog.findById(rawPostId).select(\"_id\").lean();\n+    if (!post) return res.status(404).json({ error: \"Post not found\" });\n+\n+    await Comment.create({\n+      post: rawPostId,\n+      name,\n+      email,\n+      message,\n+    });\n+\n+    return res.status(201).json({ ok: true, message: \"Saved; pending approval.\" });\n+  } catch (err) {\n+    console.error(\"createPublic comment error\", err);\n+    return res.status(500).json({ error: \"Server error\" });\n+  }\n+};\n+\n // GET /api/comments?postId=...  (approved only)\n exports.listPublic = async (req, res) => {\n   try {\n     const { postId } = req.query;\n"
                },
                {
                    "date": 1762845372950,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,22 +74,22 @@\n   }\n };\n \n // GET /api/comments?postId=...  (approved only)\n-exports.listPublic = async (req, res) => {\n-  try {\n-    const { postId } = req.query;\n-    if (!postId) return res.status(400).json({ error: \"postId required\" });\n+// exports.listPublic = async (req, res) => {\n+//   try {\n+//     const { postId } = req.query;\n+//     if (!postId) return res.status(400).json({ error: \"postId required\" });\n \n-    const rows = await Comment.find({ post: postId, approved: true })\n-      .sort({ createdAt: 1 })\n-      .lean();\n-    res.json(rows);\n-  } catch (err) {\n-    console.error(\"listPublic comments error\", err);\n-    res.status(500).json({ error: \"Server error\" });\n-  }\n-};\n+//     const rows = await Comment.find({ post: postId, approved: true })\n+//       .sort({ createdAt: 1 })\n+//       .lean();\n+//     res.json(rows);\n+//   } catch (err) {\n+//     console.error(\"listPublic comments error\", err);\n+//     res.status(500).json({ error: \"Server error\" });\n+//   }\n+// };\n \n // -------- ADMIN --------\n \n // GET /api/admin/comments?postId=...&approved=true|false (optional filters)\n"
                }
            ],
            "date": 1762458437728,
            "name": "Commit-0",
            "content": "// blog-backend/src/controllers/commentController.js\nconst Comment = require(\"../models/Comment\");\nconst Blog = require(\"../models/Blog\");\n\n// -------- PUBLIC --------\n\n// POST /api/comments\n// body: { postId, name, email, message }\nexports.createPublic = async (req, res) => {\n  try {\n    const { postId, name, email, message } = req.body || {};\n    if (!postId || !name || !email || !message) {\n      return res.status(400).json({ error: \"Missing required fields\" });\n    }\n\n    // sanity: make sure blog exists\n    const exists = await Blog.findById(postId).lean();\n    if (!exists) return res.status(404).json({ error: \"Post not found\" });\n\n    const comment = await Comment.create({ post: postId, name, email, message });\n    res.status(201).json({ ok: true, id: comment._id });\n  } catch (err) {\n    console.error(\"createPublic comment error\", err);\n    res.status(500).json({ error: \"Server error\" });\n  }\n};\n\n// GET /api/comments?postId=...  (approved only)\nexports.listPublic = async (req, res) => {\n  try {\n    const { postId } = req.query;\n    if (!postId) return res.status(400).json({ error: \"postId required\" });\n\n    const rows = await Comment.find({ post: postId, approved: true })\n      .sort({ createdAt: 1 })\n      .lean();\n    res.json(rows);\n  } catch (err) {\n    console.error(\"listPublic comments error\", err);\n    res.status(500).json({ error: \"Server error\" });\n  }\n};\n\n// -------- ADMIN --------\n\n// GET /api/admin/comments?postId=...&approved=true|false (optional filters)\nexports.listAdmin = async (req, res) => {\n  try {\n    const { postId, approved } = req.query;\n    const q = {};\n    if (postId) q.post = postId;\n    if (typeof approved !== \"undefined\") q.approved = approved === \"true\";\n\n    const rows = await Comment.find(q)\n      .populate(\"post\", \"title slug\")\n      .sort({ createdAt: -1 })\n      .lean();\n\n    res.json(rows);\n  } catch (err) {\n    console.error(\"listAdmin comments error\", err);\n    res.status(500).json({ error: \"Server error\" });\n  }\n};\n\n// PUT /api/admin/comments/:id/approve\nexports.approve = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const row = await Comment.findByIdAndUpdate(\n      id,\n      { $set: { approved: true } },\n      { new: true }\n    );\n    if (!row) return res.status(404).json({ error: \"Not found\" });\n    res.json({ ok: true });\n  } catch (err) {\n    console.error(\"approve comment error\", err);\n    res.status(500).json({ error: \"Server error\" });\n  }\n};\n\n// DELETE /api/admin/comments/:id\nexports.remove = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const row = await Comment.findByIdAndDelete(id);\n    if (!row) return res.status(404).json({ error: \"Not found\" });\n    res.json({ ok: true });\n  } catch (err) {\n    console.error(\"delete comment error\", err);\n    res.status(500).json({ error: \"Server error\" });\n  }\n};\n"
        }
    ]
}